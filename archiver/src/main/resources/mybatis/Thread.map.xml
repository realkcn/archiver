<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.kbs.archiver.persistence.ThreadMapper">
	<select id="countAll" resultType="int">
		select count(*) from thread;
	</select>

	<select id="selectAll" resultType="org.kbs.archiver.ThreadEntity">
		select * from thread order by threadid asc
	</select>

	<insert id="insert" parameterType="org.kbs.archiver.ThreadEntity">
		insert into
		thread(threadid,boardid,subject,posttime,articlenumber,author,lastreply,lastposttime,
		originid,encodingurl) values
		(#{threadid},#{boardid},#{subject},#{posttime},#{articlenumber},#{author},
		#{lastreply},#{lastposttime},#{originid},#{encodingurl})
		ON DUPLICATE KEY UPDATE
		boardid=#{boardid},subject=#{subject},posttime=#{posttime},articlenumber=#{articlenumber},
		author=#{author},lastreply=#{lastreply},lastposttime=#{lastposttime},originid=#{originid},encodingurl=#{encodingurl}
	</insert>

	<update id="update" parameterType="org.kbs.archiver.ThreadEntity">
		update thread set
		boardid=#{boardid},subject=#{subject},posttime=#{posttime},articlenumber=#{articlenumber},
		author=#{author},lastreply=#{lastreply},lastposttime=#{lastposttime},originid=#{originid},encodingurl=#{encodingurl}
		where threadid=#{threadid}
	</update>
	<update id="updateOriginid">
		update thread,(select article.originid,article.threadid from article,
		    (select threadid,articleid from article where boardid=#{boardid} order by posttime asc) tids 
		         where article.articleid=tids.articleid group by tids.threadid) a 
		    set thread.originid=a.originid where thread.threadid=a.threadid;
	</update>
	<update id="resetOriginidByBoard" parameterType="long">
		update thread set originid=-1 where boardid=#{boardid}
	</update>

	<delete id="delete" parameterType="long">
		delete from thread where threadid=#{threadid}
	</delete>
	<delete id="deleteByBoard" parameterType="long">
		delete from thread where boardid=#{boardid}
	</delete>
	<select id="get" parameterType="long" resultType="org.kbs.archiver.ThreadEntity">
		select * from thread where threadid=#{threadid}
	</select>
	<select id="getByBoardPerPage" resultType="org.kbs.archiver.ThreadEntity">
		SELECT * FROM thread where boardid=#{boardid} and isvisible=true ORDER BY lastposttime desc limit #{offset},#{limit}
	</select>
	<select id="getByOriginId" parameterType="long"
		resultType="org.kbs.archiver.ThreadEntity">
		select * from thread where boardid=#{boardid} and originid=#{originid} limit 1
	</select>
	<select id="getByEncodingUrl" parameterType="String"
		resultType="org.kbs.archiver.ThreadEntity">
		select * from thread where encodingurl=#{encodingurl}
	</select>
	<select id="getThreadsOnBoard" parameterType="long"
		resultType="org.kbs.archiver.ThreadEntity">
		select * from thread where boardid=#{boardid}
	</select>
	<cache eviction="FIFO" flushInterval="3600000" size="1024"
		readOnly="true" />
</mapper>
